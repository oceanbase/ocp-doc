# 将告警对接到企业微信群

您可使用企业微信群接收告警消息，通过机器人发送消息到企业微信群，所有群成员都可以看到告警消息。

## 应用场景

OCP 的告警消息会推送给企业微信群里的机器人，由机器人将告警消息发送到群里。对接企业微信机器人只需提供企业微信机器人的 Webhook 地址即可。

部分增强功能如下：

* @某个群成员：需配置被@人的手机号码。
* 定义消息 markdown 格式，可以对告警名加粗，告警信息按列表展示。
* 设置代理：如果内网与公网不通，需要设置网络代理，告警消息先发送到代理，代理再转发到企业微信群。

## 前提条件

* 已完成企业微信群机器人的创建及设置。每个机器人发送的消息不能超过 20 条/分钟。

  企业微信机器人接入，请参见，[企业微信机器人官方文档](https://developer.work.weixin.qq.com/document/path/91770)。

  1. 群设置中管理群机器人。

     在企业微信群中，选择 **设置** > **管理机器人** > **添加机器人**。

     ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6-1.png)

  2. 添加成功后可查看 Webhook 地址。

     ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6-2.png)

* 已获得企业微信机器人的 Webhook。设置完企业微信机器人后，您会得到机器人的 Webhook，此为配置 OCP 企业微信告警通道的必填项，为了保证告警消息的安全，请确保此 Webhook 不被泄露。

  获取到企微机器人 Webhook 后请确保网络畅通，可以用以下命令来发送一条测试消息：

    ```shell
    curl -XPOST 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=补充完整您的Webhook地址' \
    -H 'Content-Type:application/json; charset=utf-8' \
    --data '{"msgtype":"text","text":{"content":"企业微信告警测试消息"}}' \
    --compressed \
    --insecure
    ```

## 操作步骤

1. 在左侧导航栏中，单击 **监控告警** > **告警**。

2. 在告警详情页中，单击 **告警通道**。

    ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6-1.png)

3. 然后在告警页签下，单击 **新建通道**。

4. 配置企业微信告警通道。

    1. 基本配置。

        ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6-3.png)

        | 选择项 | 是否必选 | 描述 |
        |-------|----------|------|
        | 通道类型 | 是 | 下拉选择企业微信。 |
        | 通道名 | 是 | 自定义通道名称，方便后续识别。 |
        | Webhook 地址 | 是 | 企业微信机器人的访问地址，获取方式请参见，[企业微信机器人官方文档](https://developer.work.weixin.qq.com/document/path/91770)。 |
        | 签名秘钥 | 否 | 企业微信机器人提供了 3 种安全设置，选择加签设置后可以获取到签名秘钥。 |
        | @指定用户 | 否 | 输入的手机号应为用户在企业微信的登录手机号，当出现告警时机器人会@该成员，支持输入多个成员手机号，以半角逗号分隔。 |
        | 代理 | 否 | 设置网络代理，OB Cloud 4.2.0 之前的版本需设置格式为 `http:ip:port`，4.2.0 及之后的版本设置为 `http://ip:port`。<main id="notice" type='notice'><h4>注意</h4><p>http 代理如果不支持 https，则企业微信 Webhook 中的 https 需改为 http。</p></main> |

    2. 消息配置。

        ![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6-4.png)

        1. 消息格式的默认配置，OB Cloud 4.2.1 之前的版本为文本格式，4.2.1 及之后的版本更改为 markdown 格式。

        2. 消息结构可以更改，默认的消息格式样例：

           设置 **消息格式** 为 `markdown`，可通过输入 `${}` 引入变量。

            ```shell
            ### OCP 告警通知 ${alarm_name}
            - 级别：${alarm_level}
            - 告警对象：${alarm_target}
            - 概述：${alarm_summary}
            - 生成时间：${alarm_active_at}
            - 详情：${alarm_description}
            - OCP 链接：${alarm_url}
            ```

5. 其他功能。

   告警消息聚合：可以开启通道聚合功能，避免一段时间内一条告警发送多次。OCP 告警默认 3 分钟（从 4.1.0 版本开始）产生一次告警，开启告警通道聚合之后，相同告警默认 600 秒仅发送一次。

6. 单击 **提交**，完成配置。

## 常见问题

### 消息限流

Q：如何处理限流问题？

A：企业微信机器人的限流策略为“每个机器人发送的消息不能超过 20 条/分钟，若您的告警策略较多，建议多创建几个机器人，分散绑定告警策略。避免多个告警策略在同一时间触发告警时，导致您无法接收部分告警通知。”。被限流后可以看到发送失败原因。限流后所有发往企业微信群的消息都会失败，存在一定的隐患，解决方法：

* 告警通道开启聚合功能，同类告警、相同告警在聚合周期内只发送一次告警。
* 推送限流，OCP 推送设置中提供了限流策略，支持按天、小时来限流（限流维度是推送配置+告警通道）。
* 黑屏调整 `ocp.alarm.event.resend-interval-seconds` 系统配置，默认 3 分钟产生一次告警事件。

以上步骤可以有效减少告警消息数量，降低告警被限流的可能性；但是瞬时产生大量不同告警可能会被限流（1 分钟内发送超过 20 条消息）。

### 网络不通

Q：如何处理用户环境不能直接访问企业微信 API 的问题？

A：首先通过 curl 测试是否能发送测试消息，如果网络不通，则需要在 **新建通道** > **基本配置** > **代理** 中配置网络代理。

### 升级迁移

Q：升级或者迁移后，如何更新告警推送？

A：OCP 4.0.1 之前的版本是通过 HTTP 通道或脚本通道发送企业微信告警消息，4.0.1 及之后的版本推荐增加内置的企业微信通道。为避免出现校验发送结果失败的情况，请参考如下说明：

* 如果您使用的通道类型为HTTP或脚本通道，并且告警是发往企业微信群，推荐您使用内置的企业微信通道，参考本文配置。

* 如果是发往客户的告警平台，客户告警平台再发往企业微信群，则无需更改为内置的企业微信通道，还使用原来的告警通道类型。

### Response 校验信息失败

Q：如何解决 Response 校验信息失败？

A：设置 Response 校验信息失败是为了防止脚本编写不规范导致用户收不到告警、漏发告警等问题。要求脚本里输出有且仅有一次有效信息（可以是 API 响应码，也可以是 API 响应体），OCP 来校验信息是否匹配。支持正则匹配、json键值对匹配，企业微信机器人 API 返回的为 json 内容，故应使用 json 键值对匹配。企业微信群消息通道的 Response 校验信息应设置为：`{"errcode":0,"errmsg":"ok"}`，脚本通道中不应输出除 Response 外的其他内容（如 curl 命令应加上 -s 参数防止输出进度信息）。
