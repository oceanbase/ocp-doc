# 使用 OCP 巡检发现 OceanBase 集群潜在风险

本节为您介绍如何通过 OCP 巡检发现 OceanBase 集群潜在风险。

## 应用场景

在 OceanBase 运行的过程中，OCP 提供了实时的监控服务来监控集群以及周边组件的健康状况。如果集群健康有明显的下降（例如 OBServer 宕机），监控系统则会立刻给出相应地告警，这类状况往往具有确定性、突发性、紧急性等特性，若未及时处理往往可能造成严重的后果。当然，除紧急状态外，OceanBase 也会处于亚健康的状态，此类状况往往不会立刻造成什么严重的后果，而是需要一些特定的场景或时间的积累后，才可能造成影响。

结合此类状况往往比较隐匿，发现或者诊断需要一定的查询时间，无法实时地、高频率地去监控此类状况。**巡检** 即是 OCP 专门针对于发现集群潜在风险（亚健康状态）提供的功能。巡检功能最短可以设置一天的周期（或随时手动触发立即巡检），对 Oceanbase 集群、OBProxy 等做潜在风险的挖掘，并最终生成巡检报告。

由于巡检的非实时特性，巡检报告中可以呈现更为详细的内容，加上巡检支持高度自由的配置方式，用户可以自定义任何所需指标，并灵活地选择展示在报告中的内容。

## 前置条件

* OCP 为 V4.0.3 及以上版本。

* OCP 中存在需要被巡检的对象。

## 技术原理

从技术实现上来说，OCP 巡检模块实现了 **数据查询** > **数据处理** > **结果判断** 三个可配置流程，可灵活地在 OCP 未更新版本的情况下自定义新的巡检项。

巡检脚本是整个配置的核心，脚本中可以通过内置对象查询到被巡检对象的监控（metric）、内部表以及通过 agent 接口提供的宿主机的相关状态数据。同时，巡检脚本也可以对查询到的状态进行分析和处理，并将最终处理结果输入到巡检报告中。

OCP 内置巡检项是在一些通用的场景或者实践下总结而来的通用检查项，基本可以满足通用巡检需求，并且内置巡检项也在持续地积累中。OCP 支持用户根据所需定制个性化巡检项，例如根据自身业务的分区键所定制的分区边界检查，此时也可以通过完成上述流程的配置，来添加自定义巡检项。

<main id="notice" type='explain'>
<h4>说明</h4>
<p>自定义巡检项会涉及到对巡检模块中对象的理解以及脚本的编写，此部分目前暂不支持白屏化配置。若您有自定义巡检项需求，可联系 OCP 技术支持进行协助。</p>
</main>

## 操作步骤

### 手动巡检

1. 巡检功能的使用围绕着巡检对象展开，若无需对巡检项进行筛选，在巡检页面选择相应的巡检对象，发起一次巡检即可。

     ![image.png](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8F%91%E8%B5%B7%E5%B7%A1%E6%A3%80.png)

2. 巡检发起后，等待巡检项全部检查完毕，即可查看巡检报告。

### 定时巡检

定时巡检可以针对不同的对象配置不同的巡检时间，或者针对全局的所有的对象配置统一的巡检时间，具体流程如下：

1. 配置巡检规则，可选择对指定对象配置个性化巡检规则，或对所有对象配置全局巡检规则。

     ![image.png](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E9%85%8D%E7%BD%AE%E8%B0%83%E5%BA%A6%E8%A7%84%E5%88%99.png)

     ![image.png](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E8%B0%83%E5%BA%A6%E8%A7%84%E5%88%99.png)

2. 在巡检规则的具体配置页面，针对不同的巡检类型，可以定义不同的巡检周期，周期粒度包括月、周、日。

     ![image.png](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E8%B0%83%E5%BA%A6%E8%A7%84%E5%88%99.png)

3. 巡检周期设定完成后，巡检会在所设定的时间自动触发，巡检报告的呈现方式与手动触发的相同。

## 常见问题

Q：巡检报告中的 **`**can not query**`** 是什么原因？
A：在 **技术原理** 中简单地介绍了巡检运行的过程，第一步需要获取待巡检对象的相关状态，`can not query` 便是发生在这个过程中的异常。该异常会导致获取不到待巡检对象的状态，也就不能进行后续的分析和处理。例如，当需要检查某个集群的参数是否配置合理，首先需要查询集群中该参数的实际值，如果此时集群不可连接，那么参数值则不可查，报告中相应的检查项便会显示为 `can not query`。

`can not query` 一般是不可预期的异常导致，如上述例子，集群不可查询本身就是比较严重的症状，所以一般 `can not query` 的检查项都会有风险提示，而引起 `can not query` 的直接原因，则需要到巡检历史中找到对应的巡检任务，并在任务界面查看相应的错误信息。

## 关键巡检项说明

* [Clog 同步检查](1610.clog-synchronization-check.md)
* [网卡速率检查](1620.network-card-speed-check.md)
* [自增列可用性检查](1630.auto-increment-column-availability-check.md)
