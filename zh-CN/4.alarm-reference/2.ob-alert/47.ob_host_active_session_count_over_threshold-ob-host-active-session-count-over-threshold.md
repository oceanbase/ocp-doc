# ob_host_active_session_count_over_threshold OB 服务器活跃会话数超限

## 告警描述

OBServer 活跃会话数超过阈值，触发该告警。

## 告警原理

下表列出了该告警监控逻辑中涉及的关键参数。

| **参数** | **值** |
| --- | --- |
| 监控指标 | active_session：该指标表示活跃会话数，当其值大于默认值 （10000），则触发告警。 |
| 数据来源 |```select  /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK)*/ case when cnt is null then 0 else cnt end as cnt, tenant_name, tenant_id from (select __all_tenant.tenant_name,__all_tenant.tenant_id, cnt from __all_tenant left join (select count(`state`='ACTIVE' OR NULL) as cnt, tenant as tenant_name from__all_virtual_processlist where svr_ip = ? and svr_port = ? group by tenant) t1 on __all_tenant.tenant_name = t1.tenant_name) t2;```。SQL 中的 “?” 表示变量，实际采集数据时会传入参数，参数分别是本机 IP 和 RPC 端口。 |
| 采集指标 | ob_active_session_num |
| 监控表达式 | sum(ob_active_session_num{@LABELS}) by (@GBLABELS) |
| 采集周期 | 1 分钟 |

## 规则信息

| **监控指标** | **默认阈值** | **持续时间** | **告警周期** | **消除周期** |
| --- | --- | --- | --- | --- |
| active_session | 500 | 0 秒 | 60 秒 | 5 分钟 |

## 告警信息

| **告警触发方式** | **告警等级** | **范围** |
| --- | --- | --- |
| 基于监控指标的表达式 | 严重 | OB 服务器 |

## 告警模板

* 告警概述
  * 模板：\${alarm_target} ${alarm_name}
  * 样例：ob_cluster=obcluster1-1:svr_ip=192.168.0.1 OB 服务器活跃会话数超限
* 告警详情
  * 模板：\${alarm_target} \${alarm_name} OB服务器 \${svr_ip} 活跃会话数：\${value}，超过阈值 ${alarm_threshold}。
  * 样例：ob_cluster=obcluster1-1:svr_ip=192.168.1.1 OB 服务器活跃会话数超限 OB 服务器 192.168.1.1 活跃会话数：1000， 超过 500。

## 对系统的影响

活跃会话数是当前系统正在为客户端提供服务的数量，其数量代表了当前系统的繁忙程度。一般，活跃会话数上限跟集群下租户的资源（主要是 CPU）有一定的关系。当租户资源较为充沛时，活跃会话数的告警阈值可以设置稍高一点，以满足业务的会话数量。该告警的阈值设置也需参考连接数的设置，根据系统的参数设置，预期设置活跃会话数超过多少就产生告警。

当活跃会话数超过预期数量，可能导致：

* 服务器 CPU 超限，导致其他服务无法正常工作。
* OceanBase 繁忙，若处理不过来，可能导致内存上升，触发内存上限。

活跃会话数超限告警不是根因，这个告警指标可以结合 CPU、内存相关告警指标一起定位错误原因。

## 可能原因

活跃会话数超过预期，可能的原因有：

* 租户 CPU 资源不足，导致租户处理请求不及时，出现活跃会话数上升。

* 租户内存资源不足，间接导致 OceanBase 处理请求不及时。

* 活跃会话数阈值设置太低，在业务高峰时，容易触发告警阈值。

## 处理方法

1. 排查是否存在 [tenant_cpu_percent_over_threshold OB 租户 CPU 使用率超限](54.tenant_cpu_percent_over_threshold-tenant-cpu-percent-over-threshold.md) 或 [tenant_memstore_percent_over_threshold OB 租户内存使用百分比超限](36.tenant_memstore_percent_over_threshold-ob-tenant-memory-usage-percentage-exceeds-the-upper-limit.md) 告警，若存在可能是资源不足导致的告警，可参考这两个告警的处理步骤处理，然后观察告警是否自动清除。
2. 排查当前是否业务高峰期或存在突刺。
   您可参考 [性能监控](3.ob-cloud-platform/4.manage-clusters/8.cluster-performance-monitoring.md) 查看告警集群 **性能监控** 页面的 **数据库性能** 页签中，各指标的趋势图。
   * 如果在告警上报的那段时间里，各指标长时间高于平时，则是业务高峰期。
  此时您可忽略告警，或者将告警阈值调高。
   * 如果在告警上报的时间段内，其他指标未高于平时，且 **活跃会话数** 指标总有某个时间点突然飙高，则可能是活跃会话数存在突刺。
  您适当调整告警 **触发条件** 里的 **持续时长**。
