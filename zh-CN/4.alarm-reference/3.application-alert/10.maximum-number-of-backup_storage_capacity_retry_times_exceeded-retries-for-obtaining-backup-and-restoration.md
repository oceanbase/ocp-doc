backup_storage_capacity_retry_times_exceeded 备份恢复容量获取重试次数超限
================================================================================



**告警描述**
-----------------------------

进行备份恢复时需要获取容量，OCP 与备份服务器之间网络异常等原因造成获取失败时，会进行重试，当重试次数超过一定数量时，触发该告警。

告警原理
-------------------------

下表列出了该告警监控逻辑中涉及的关键参数。


|  参数   |                                                                                                 值                                                                                                  |
|-------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 监控指标  | storage_capacity_monitor_error_code                                                                                                                                                                |
| 指标来源  | OCP-Server 监控备份恢复的存储容量，当发生以下情形时记录相应错误码并赋值给采集指标。 * 1001：获取目录容量重试次数超限。   * 1002：获取目录容量超时或线程被中断    |
| 采集指标  | storage_capacity_monitor_error_code                                                                                                                                                                |
| 监控表达式 | max(storage_capacity_monitor_error_code{@LABELS}) by (@GBLABELS)                                                                                                                                   |
| 采集周期  | 1 秒                                                                                                                                                                                                |


**说明**



该告警的指标来源相对特殊，具体请参考上表中 **指标来源** 的说明。

监控指标的值是 OCP-Server 监控备份恢复存储容量时采集来的错误码，当监控指标值为 1001 时触发告警。

**规则信息**
-----------------------------



|                监控指标                 | 默认阈值 | 持续时间 | 检测周期  | 消除周期  |
|-------------------------------------|------|------|-------|-------|
| storage_capacity_monitor_error_code | NA   | 0 秒  | 30 分钟 | 40 分钟 |



**告警信息**
-----------------------------



| 告警触发方式  | 告警等级 | 范围 |
|---------|------|----|
| 监控表达式触发 | 停服   | 服务 |



**告警模板**
-----------------------------

* 概述模板: \${alarm_target} ${alarm_name}



* 详情模板: \${alarm_target} ${alarm_name}



* 概述样例: storage_url=file:///obbackup/yc225_214/ 备份恢复容量获取重试次数超限 获取容量重试次数超限, 错误码:1001.0



* 详情样例: storage_url=file:///obbackup/yc225_214/ 备份恢复容量获取重试次数超限 获取容量重试次数超限, 错误码:1001.0






其中，${alarm_target} 的格式为 storage_url=xxxxxxx。

**对系统的影响**
-------------------------------

备份恢复页面中的存储容量趋势数据间隔大于半小时，甚至无法显示。

**可能原因**
-----------------------------

* OCP 与备份存储服务器之间网络异常。



* 备份存储无法访问或者异常。






**处理方法**
-----------------------------

* 确认是否 OCP 与备份存储服务器之间网络故障。

  参考如下命令确认二者是否网络故障。

  ```unknow
  #在 OCP 服务器上 ping 备份存储服务器，192.168.0.1 为备份存储主机 IP。
  ping 192.168.0.1
  
  #在备份存储服务器上 ping OCP 服务器，192.168.0.2 为 OCP 主机 IP。
  ping 192.168.0.2
  ```


  * 若有返回连续的数据发送信息，则网络正常，可能是其他原因导致告警。



  * 若未返回连续的数据发送信息，则网络故障。

    请联系网络管理员排查具体的网络问题，若无网络管理员请参考 [网络故障排查](4.alarm-appendix/6.network-troubleshooting.md) 进行排查并修复。





* 确认是否备份存储目录无法访问。

  1. 登录备份存储服务器。



  2. 进入备份存储目录的上层目录后执行 ll 命令，查看该目录 admin 用户是否有读权限。

     ```unknow
     # /obbackup 为默认的备份存储目录。
     cd / && ll | grep obbackup
     
     #返回如下内容
     drwxrwxrwx   16 root root 4096 Aug 10 14:34 obbackup
     ```


     * rwxrwxrwx 表示所有用户可读可写可执行。



     * 两个 root 分别表示备份文件存储目录所属用户，及用户的属组。






     非此权限，admin 用户可能无法访问。需用户通过 www.baidu.com 了解 Linux 权限后进行分析。


  3. 若权限不足，可参考如下命令修改备份存储目录的权限，保证其可访问。

     ```unknow
     chmod -R 777 /obbackup 
     ```
