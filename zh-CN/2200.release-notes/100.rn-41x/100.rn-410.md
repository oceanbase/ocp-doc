# OCP V4.1.0

#RNDate#2023-05-26

## V4.1.0 BP2

### 版本信息

* **版本号：** V4.1.0 BP2

* **前置版本：** V4.1.0 BP1

* **版本发布日期：** 2023 年 09 月 01 日

### 缺陷修复

* 修复租户 CPU 使用率显示值比实际大了 100 倍的问题。

* 修复非 root 用户添加主机可能会失败的问题。

* 修复无用的告警历史清理失败的问题。

* 修复监控中事务响应时间显示值比实际大了 1000 倍的问题。

* 修复部分实时性监控滞后两分钟才可被查询到的问题。

* 修复了扩容时无法选择大于 2 个 Unit 的问题。

## V4.1.0 BP1

### 版本信息

* **版本号：** V4.1.0 BP1

* **前置版本：** V4.1.0

* **版本发布日期：** 2023 年 07 月 20 日

### 新增功能

* 新增支持 OAuth2 和 CAS 两种通用的单点登录（SSO）认证授权方式。

* 优化产品内英文术语及文案，实现多语言切换能力，满足产品国际化要求。

* 优化 OBAgent 启动逻辑，支持自动清理历史 PID 文件。

* 支持 OceanBase V4.2.0.0 版本基础场景的运维管控，用以支持 POC。

### 缺陷修复

* 修复当 MetaDB 使用 `127.1` 地址时带来的跨 OCP 集群的一系列问题。

* 修复拓扑图无监控数据的问题。

* 修复二次备份取消后无法重新调度备份任务的问题。

* 修复 OpenAPI 导入主机接口报错的问题。

* 优化在特定 shell 环境中添加主机失败的问题。

* 优化主机添加流程，在禁用 ICMP 保温的情况下也可以添加成功。

* 优化主备库切换场景的容错性，禁止一些错误操作。

* 增加主机管理对 openEuler 系统的兼容性。

## OCP V4.1.0

OceanBase V4.x 的架构及产品形态发生了较大的变化，而且也带来了众多的新特性。OCP 作为 OceanBase 的配套运维管理平台，需要能够将 OceanBase 的新特性以更加简单易用的方式呈现给用户，降低用户的使用难度。另外，本次版本作为 OCP 的大版本，也进一步优化了产品使用体验，调整了产品架构，提升了产品能力。

### 版本信息

* **版本号：** V4.1.0

* **前置版本：** V4.0.3

* **版本发布日期：** 2023 年 05 月 26 日

* **支持的升级路径：**

  * 目前仅支持从 OCP V3.2.4 及之后版本直接升级到当前版本。

  * 对于 OCP V2.3.x 及之后、V3.2.4 之前的版本，需先升级至 OCP V3.3.4 版本。

  * 对于 OCP V2.3.0 之前版本，需先升级至 OCP V2.3.x 版本，再升级到 OCP V3.3.4 版本。

### 支持的 OceanBase 数据库版本

OCP V4.1.0 版本支持下表所列版本的 OceanBase 数据库。

* OceanBase V1.4.x

* OceanBase V2.1.x

* OceanBase V2.2.x

* OceanBase V3.1.x

* OceanBase V3.2.x

* OceanBase V4.x

### 新增功能

#### OceanBase V4.x

* **单机分布式一体化**

  实现同时管理 **单机集中式**（仅 OceanBase V4.1 及以上版本）或 **分布式集群** 的 OceanBase 环境，满足不同场景用户需求。

  * 支持创建集群时选择 **单机集中式** 或 **分布式集群** 模式，并精简 **单机集中式** 环境部署流程。

  * 支持部署 **单机集中式** 时使用集群最大可用资源同步创建一个业务租户，实现业务即开即用。

  * 支持在线扩展 **单机集中式** 为 **分布式集群**，满足业务增长及更高安全性需求。

* **仲裁服务**

  支持当 OceanBase 集群为 V4.1 及以上版本时对 2F 或 4F 的租户配置仲裁服务，降低多副本高可用的仲裁成本。

  * 新增 **仲裁服务管理** 功能，实现仲裁服务的部署、启停、删除、升级等能力。

  * 支持在一个节点部署多个仲裁服务实例，满足不同集群的仲裁高可用需求。

  * 支持在 V4.1 及以上版本的 OceanBase 集群中添加、替换、移除仲裁服务能力。

  * 支持集群已添加仲裁服务后，为 2F 或 4F 的租户开启或关闭仲裁服务能力。

#### 平台功能

* **新信息架构**

  * 原一级入口 **软件包** 移至 **系统管理** 下，更名为 **软件包管理**。

  * 新增一级入口 **监控告警**，将原 **系统管理** 下的 **告警** 和 **巡检** 移动至该路径下。

  * 原 **系统管理** 下的 **日志服务**，提升到一级入口。

  * 原 **系统管理** 下的 **任务** 入口，移动至 **首页** 右上角。

  * 原一级入口 **诊断中心** 更名为 **自治服务**。

  * 原 **系统管理** 下的 **历史事件** 更名为 **操作审计**。

  * 原 **系统管理** 下的 **安全** 更名为 **用户管理**。

* **装机模板**

  对于添加到 OCP 中的主机，支持针对数据库环境进行标准化设置。

* **多路 OSS 异地备份**

  * 生产集群本地 OSS 备份，同时将本地备份复制到异地 OSS。

  * 两地 OSS 的备份调度、备份周期以及保留策略不同，本地保留 30 天备份，异地保留 7 天备份。

  * 异地 OceanBase 集群可以通过异地 OSS 进行租户恢复。

  * 复制日志备份时，先同步日志备份，再同步日志元数据，以提高日志备份的时效性要求。

### 功能优化

* 设置备份策略时，支持 OSS 访问域名中输入端口号。

* 部署 OBProxy 集群时增加对 OBProxy 日志目录可读写权限的检查。

* 机器重启后，ocp_agent 进程自动拉起。

* SQL 诊断支持不同主机执行对比。

* 创建集群时，新增 Zone 优先级配置开关，开关关闭时 sys 租户的 Zone 优先级保持 OceanBase 的默认行为，即当集群版本为 V4.x 以下时，以第一个 Zone 为第一优先级；集群版本为 V4.x 及以上时为 random 优先级。

* 全局视图概览页备份存储趋势接口速度优化。

* 诊断中心首页展示优化。

* 日志备份延时告警默认值调大。

* OCP 告警项增加非 memstore 区域的内存告警。

* 支持自定义添加写锁等待失败次数和每个锁等待平均耗时告警项。

* OCP Agent 增加摘要认证方式。

* 增加 obproxy 机器上 `max open files` 的巡检项。

* 增加参数用于控制开启 cgroup 的起始 OceanBase 数据库版本。

* 监控查询优化，通过异步化查询，查询计算链路代码优化、抽象存储层等方案，削减监控查询峰值压力，从而提高监控接口整体吞吐量。

* 容量中心新增 **容量风险** 和租户**容量使用总览**。

### 安全提升

* Web 页面访问接口交互涉及的敏感信息加密传输。

* 全新部署 OCP 时，去掉内置初始密码，改为由用户指定密码。

* 上传软件包完成后，弹窗提示 sha1 值，用户需进行二次确认。

## 其它

OceanBase 品牌 logo 换新。

### 缺陷修复

* 修复了在有备集群的集群级告警中，备集群名称显示为 “undefined” 的问题。

* 修复了租户资源管理磁盘统计量有时不准确的问题。

* 修复了升级 OBProxy 版本失败的问题。

* 修复了删除资源后仍会产生 “exporter 不存在” 的误告警问题。

* 增加了对 OceanBase V4.1 恢复状态显示的兼容性问题。

* 修复了使用默认参数创建的屏蔽条件对 “慢查询 SQL 次数超限” 告警未生效的问题。

* 修复了 OCP 用户无权限却可以查看监控告警数据的问题。

* 优化了 OBProxy 集群新创建时就告警 “进程不存在” 的问题。

* 修复了文件系统、磁盘信息采集超时导致的 agent 大量报错日志的问题。

* 修复了 OBProxy 集群大于 1 页时无法翻页的问题。

* 修复了同时存在 el6 和 el7 同版本 OceanBase 软件包，导致 OceanBase 无法发起升级的问题。

* 优化 OCP 镜像，增加了 Python 常用类库。

* 优化了总览页无权限访问弹出大量权限提示的问题。

### 已知问题

| 编号 | 已知问题      | 规避方法   |
|----|---------|---------------|
| 1  | 当在二次备份执行过程中删除了备份策略（带二次备份），再次新建备份策略时，调度会失败。 |待二次备份结束后，连接 OceanBase 并执行 `sql: alter system set backup_backup_dest = "";` 命令手动清空 `backup_backup_dest`。 |
| 2  | OCP 上 Oracle 租户无法设置 `nls_nchar_conv_excp` 参数。      | OBProxy 的已知 bug，OCP 进行了变相的拦截。设置该参数会导致租户无法连接，请不要设置这个参数。   |
| 3  | 用户授予 `obproxy manage` 或 `obproxy_viewer` 权限后能够查看未授权的 OceanBase 集群信息。     | 暂时不要使用这两个权限。   |

### 版本使用限制

#### 硬件要求

OCP-Server 可以安装在物理机上，也支持安装运行在 Docker 容器中。OCP-Server 支持多节点高可用部署模式。

OCP-Server 节点最低硬件要求如下表所示。

| 硬件  | 要求                                 |
|-------|------------------------------------|
| CPU   | <li>X86_64，8 核</li><li>ARM aarch 64 架构，8 核</li> |
| 内存  | 可用内存 16 GB                         |
| 网卡  | 万兆网卡                               |

OCP-Agent 自身占用资源很少，对安装节点硬件资源没有特别要求。

#### 操作系统要求

安装 OCP 服务端（含 OCP-Agent）的操作系统要求如下表所示。

| 服务器类型       | 操作系统       | 支持版本      |
|-------------|------------|-----------|
| x86_64      | RHEL       | 7.2 及以上版本 |
| x86_64      | CentOS     | 7.2 及以上版本 |
| x86_64      | AliOS      | 7.2 及以上版本 |
| x86_64      | openSUSE   | 12SP3 及以上 |
| ARM aarch64 | AliOS      | 7.2 及以上版本 |
| ARM aarch64 | 中标麒麟       | 7.6       |
| ARM aarch64 | 华为 EulerOS | 2.0 SP8   |
| x86_64 | Debian       |   Debian GNU/Linux 11 (bullseye)    |
| x86_64 | Ubuntu |  Ubuntu 18.04.6 LTS  |

#### 客户端要求

一般用户会通过 Web 浏览器来访问 OCP 服务，故对客户端的要求如下所示。

| 浏览器     | 最小版本 |
|---------|------|
| Chrome  | 81   |
| Firefox | 64   |
| Safari  | 10   |
| Edge    | 13   |

如果您需要通过 iOS 操作系统的设备来访问 OCP，版本要求如下表所示。

| 操作系统 | 最小版本 |
|------|------|
| iOS  | 10   |

为了具备最佳的使用体验，推荐使用分辨率大于 1440 x 810 的显示器。
