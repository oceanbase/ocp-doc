# OCP V4.2.0

#RNDate#2023-09-22

## V4.2.0 BP2

### 版本信息

* **版本号：** V4.2.0 BP2

* **前置版本：** V4.2.0 BP1

* **版本发布日期：** 2023 年 09 月 27 日

### 缺陷修复

* 修复自治服务页面有异常事件时无法访问的问题。

* 修复修改集群参数，单击 **全选** 后报错的问题。

## V4.2.0 BP1

OCP V4.2.0 BP1 支持基于告警规则实现自动拉起 OBServer&仲裁服务、租户&OBProxy 扩容、 SQL 级别限流等 7 种预案场景，基于告警规则提供了可操作的应急处理方案，同时提供用户移动端的预案快捷操作入口，进而提升整体 OceanBase  数据库服务的稳定性。

### 版本信息

* **版本号：** V4.2.0 BP1

* **前置版本：** V4.2.0

* **版本发布日期：** 2023 年 09 月 22 日

### 新增功能

* 基于告警规则提供了可操作的应急处理方案，主要实现功能包括：

  * 基于特定类型告警解决 7 种场景的特定问题：

    * 在 OBServer 以及仲裁服务异常 Crash 场景下，OCP 会自动拉起 OBServer 和仲裁服务（在 12 个小时内仅支持拉起一次）。

    * 在租户队列积压 `ob_tenant_request_queue_over_threshold` 告警场景下，OCP 默认按照 120% 实现租户 CPU 扩容。

    * 在租户内存 `tenant_memstore_percent_over_threshold` 超过阈值的情况下，OCP 默认按照 120% 实现租户内存扩容。

    * 在 OBProxy 的客户端连接数比例超过阈值的情况下， OCP 默认按照 120% 实现集群级别的客户端连接数（client_max_connections）以及内存（proxy_mem_limited）的扩容。

    * 在检测到 SQL 执行计划异常、SQL 性能下降、CPU 飙升等异常场景下，OCP 会提供刷新 Plan Cache、绑定执行计划、SQL 级别限流等应急解决方案。

  * 支持将告警信息及解决方案推送至 “飞书”、“钉钉”、“企业微信” 等外部工具，用户通过手机端即可快速完成紧急故障处理。

  * 支持标记具备预案的告警信息，方便用户快速查询相关告警信息。

  * 支持记录/查询 Open API 调用，以便后续进行追查。

  * 支持基于集群、租户及 OBServer 三个层级进行告警功能设置。

* 新增租户队列积压告警能力，方便用户及时排查租户性能相关问题。

* 新增磁盘不可用告警，方便用户快速发现硬件故障，避免影响正常业务运行。

* 集群级别已开启仲裁服务的前提下，sys 租户副本满足 2F/4F 要求时则自动开启仲裁服务。

### 安全提升

* proxyro@sys 密码安全整改
  
  对于 V4.0 以上版本的 OceanBase 集群和 V4.0 BP2(obproxy-4.0.0-20230130103527) 以上版本的 OBProxy 集群，支持设置 proxyro@sys 账号为随机密码。

* root@proxysys 密码安全整改

  支持用户设置 OBProxy 管理员 root@proxysys 的密码，同时增加等保三规则校验。

### 缺陷修复

* 优化监控下钻的数据延迟。

* 优化 OCP agent 错误配置情况下会导致退出的问题。

* 修复了多节点 OCP 部分场景发送多次相同告警的问题。

## V4.2.0

OCP V4.2.0 正式支持 OceanBase V4.2.0，同时支持 OceanBase V4.x 的三大特性：租户级物理主备库、租户内资源隔离及租户间 IOPS 隔离。此外，OCP 自本版本开始支持自定义部署 OBServer、OBProxy 以及仲裁服务节点的用户及安装路径，满足不同用户的运维管理诉求，并提升对 OBProxy、仲裁服务的监控告警能力及自治服务模块 SQL 诊断能力。与此同时，OCP V4.2.0 在易用性上完成 20+ 项优化，如优化租户级别 CPU 使用率、实现 OBServer, OBProxy 服务重启自启动等，切实降低用户操作难度，让用户更加方便地管理运维 OceanBase 数据库。

### 版本信息

* **版本号：** V4.2.0

* **前置版本：** V4.1.0

* **版本发布日期：** 2023 年 08 月 30 日

* **支持的升级路径：**

  * 目前仅支持从 OCP V3.2.4 及之后版本直接升级到当前版本。

  * 对于 OCP V2.3.x 及之后、V3.2.4 之前的版本，需先升级至 OCP V3.3.4 版本。

  * 对于 OCP V2.3.0 之前版本，需先升级至 OCP V2.3.x 版本，再升级到 OCP V3.3.4 版本。

### 支持的 OceanBase 数据库版本

OCP V4.2.0 版本支持下表所列版本的 OceanBase 数据库。

* OceanBase V1.4.x

* OceanBase V2.1.x

* OceanBase V2.2.x

* OceanBase V3.1.x

* OceanBase V3.2.x

* OceanBase V4.x

### 产品新特性

#### OceanBase V4.x 适配

* **租户级别日志盘大小限制以及 IOPS 隔离功能**

  通过资源规格（Unit）实现对于租户使用日志盘大小以及磁盘 IOPS 的限制，实现 IO 隔离的能力。

* **租户级别物理备库管理**

  * 支持通过 **基于归档 & 基于网络** 两种方式搭建主备租户（仅支持 OceanBase V4.2.0 及以上版本）。
  * 支持备租户通过主备库日常切换（Switchover）/主备库容灾切换（Failover）功能满足本地及异地容灾的业务场景。

* **租户内资源隔离**

  OCP 基于 OceanBase 内核特性，实现如下 3 个维度的资源管控能力，从而能够使用户基于业务特性，实现最大的资源利用效率。

  * 用户资源隔离：根据用户应用类型，实现用户对 CPU、IOPS 等资源的使用限制。
  * 后台任务隔离：实现对转储、迁移、合并、备份等 8 种后台任务的资源使用限制。
  * SQL 资源隔离：通过 SQL（如指定 WHERE 条件）达到对特定业务进行资源使用限制。

* **OceanBase V4.2 功能**

  * 新增租户级别只读副本，即 OCP V4.2.0 版本中 OceanBase 支持全能型副本 & 只读型副本。
  * 新增租户级别 Unit 数量缩容能力。
  * 支持通过指定 IP 方式启动 OBServer，解决单网卡存在多个 IP 场景下错选 IP 地址的问题。
  * 通过强制要求如 memory_limit、system_memory 等容量类参数具有单位信息，降低用户错误配置参数的可能性。
  * 支持增量日志（Clog）物理读 IO 的次数、耗时以及流量的监控，方便进行实时日志盘性能诊断。
  * 支持 5 个事务表缓存命中（如 SSTable、MEMTable、KV Cache 等）监控，辅助用户进行事务相关的性能诊断。
  * 在集群 **资源管理 > Unit 分布** 中，Unit 提供租户角色以及主副本信息展示。

#### 功能提升

* **自治服务**

  * 集群透出异常事件（节点 CPU 异常），直接进行进行节点级别（集群级别）的 SQL 诊断。
  * 新建优化中心，支持对指定时间段内的 TopSQL 进行 REVIEW，查看是否可以优化，以及如何优化。同时对 SQL 对应的表结构以及索引结构进行 REVIEW，看是否有优化点并且给出优化建议。

* **监控告警**

  * 支持 OBProxy 进程状态、连通性、客户端连接数、服务端连接数、内存使用率等 5 种告警能力，增强了产品全链路监控能力。
  * 支持在关键告警如宕机、CPU 异常飙升等场景下自动收集故障信息并下载报告能力，方便用户根据故障信息进行故障诊断。

* **安装部署**

  * 通过系统参数 `ocp.operation.default.os.user` 支持自定义用户安装部署 OBServer、OBProxy 及仲裁节点及其安装目录，满足不同企业客户的运维管理规范。
  * 通过 Systemd 方式实现主机重启后自动启动 OBProxy 和 OBServer，达到降低人工操作，提升运维效率的目标。
  * 支持标识软件安装包 CPU 架构（X86 或者 ARM），降低用户选择软件包出错概率。

### 功能优化

* **集群管理模块**：

  * 在 **接管集群** 场景下支持用户录入 proxyro 密码，解决因 proxyro 密码不一致造成集群难接管问题。
  * OceanBase 数据库术语优化：root server 变更为 root service。
  * **概览 > 系统事件** 中增加 OBServer 事件收集，方便用户进行问题排查。
  * 优化集群管理页面加载速度，实现大规模的集群管理能力。

* **租户管理模块**：

  * 优化租户列表，去除 **租户 ID** 信息列，并新增 **所属集群** 排序功能。
  * **会话列表** 增加 OBServer 属性并支持筛选功能，方便用户快速进行问题诊断。

* **监控告警模块**：

  * 优化监控名称，修改 **CPU 使用率** 为 **租户 CPU 消耗**，并更新数据计算逻辑，更真实反馈租户的资源使用情况。
  * 新增 **租户线程使用率** 监控指标，方便用户快速识别租户运行状态。
  * 依据行业标准，实现 10+ 监控名称标准化，如 **租户 > 性能监控 > 存储与缓存** 中原 **IO 耗时** 变更为 **物理读 IO 耗时**，**OBProxy 集群 > 服务监控** 中原 **每秒事务数** 变更为 **TPS**。

* **巡检模块**：

  新增系统参数 `ocp.inspection.report.expired.days` 和 `ocp.inspection.report.expired.cleanup.enabled` 控制巡检报告过期策略，降低巡检报告的磁盘使用。

* **合并管理模块**：

  当系统参数 `enable_manual_merge` 为 true 时，明确提示用户需要手动进行分区合并。

* **任务管理模块**：

  实现任务与操作对象（如集群、租户、OBProxy） 相互跳转逻辑，方便用户进行对象、任务的管理。

* **操作审计模块**：

  * 支持记录 Open API 调用信息，实现更全面的安全管控。
  * 支持单个用户操作事件关联多个资源（如主机、租户等）。

### 关键特性解读

#### 租户级别 IOPS 隔离

OceanBase V4.0 通过虚拟化磁盘带宽（IOPS），解决了不同租户间磁盘争用的难题，实现如同 N 个租户运行在 N 块不同的物理磁盘，使 OceanBase 的租户具备顶级的资源隔离能力。您可以在创建 Unit 规格时指定最大 IOPS，因此相应用户下所有业务请求都会受到此 IOPS 的限制，从而达到租户间 IO 隔离的效果。

#### 租户级别物理备库功能

OceanBase 数据库在 V4.1.0 版本之前，集群有两种角色：主集群和备集群，备集群是主集群的一个数据备份，保证事务一致性。主集群会自动向备集群传输 Redo 日志，备集群会自动应用 Redo 日志，数据和 schema 在主备集群上是物理一致的。V4.1.0 版本开始，物理备库的产品形态变更为租户级主备，即主或备的角色信息属于租户，分为主租户和备租户，集群不再有主备角色的概念，而只是承载租户的容器。主租户是用户创建的业务租户，支持完整的数据库服务能力，包括：查询、DML、DDL 等；备租户则仅提供容灾和只读服务的能力。一个主租户和若干备租户共同组成了租户级的物理备库高可用解决方案。

物理备库支持通过基于日志归档以及基于网络进行搭建：

1. 基于日志归档的物理备库

   基于日志归档的物理备库中，物理备库的 Redo 日志来源于主租户或其他备租户的日志归档，类似于 Oracle 数据库的 Far Sync，备租户仅与日志归档交互，而不会和上游的主租户或备租户有任何其他形式的交互。在该部署模式下，备租户与上游租户不需要网络联通，但其同步性能和可用性会受到日志归档介质的影响。

2. 基于网络的物理备库

    基于网络的物理备库中，备租户直接通过网络连接主租户或其他备租户读取日志，类似于 MySQL 数据库的 Replication。在该部署模式下，备租户和主租户的网络需要联通。备租户会通过网络发送 RPC 请求读取主租户集群中的 Redo 日志，同时为了支持在主租户节点故障、日志回收等场景下备租户的高可用，备租户也需要少量主租户系统视图的查询权限。在该部署模式下，备租户从主租户读取的日志，既可以是主租户的在线日志，也可以是主租户的归档日志（主租户开启了日志归档模式的前提下），两种日志来源支持自动切换，对备租户以及业务的使用者透明。

OceanBase 集群的租户角色包括两种：主租户（PRIMARY）和备租户
（STANDBY）。您可以通过主备库日常切换和主备库容灾切换动态改变租户角色。
  
  1. 主备库日常切换：允许主租户与其中一个备租户交换角色，保证数据无损。
  2. 主备库容灾切换：主租户不可用的情况下，可以将一个备租户切换为主租户。

产品限制：仅支持 OceanBase V4.2.0 及以上版本。

#### 租户内的资源隔离

OceanBase 数据库中通过 PL 的 DBMS_RESOURCE_MANAGER 系统包来管理数据库中资源的分配从而实现资源隔离，整体配置难度较高。OCP 通过高度精炼的方式简化用户配置难题，实现了用户级别资源隔离以及SQL级别资源隔离。

1. 优化创建流程，通过三步：配置资源隔离计划 > 配置资源组  > 进行资源隔离限制，即可完成轻松创建资源隔离计划。

2. 优化资源隔离的查看用户语义，例如 CPU、IOPS 上下限和权重的转化及 SQL 表达式等。

3. 具备动态调整资源隔离计划能力，如启用、停用、修改及删除资源隔离计划等。

### 缺陷修复

* 优化 MetaDB 不可用时的告警表现。

* 优化 OBProxy 的参数配置，开放了一些只读参数的修改。

* 修复告警归档时间参数不生效的问题。

* 修复主机监控推送至 Prometheus 而不被识别的问题。

* 修复特定场景下主机标准化失败的问题。

* 修复 **自治服务 > SQL 详情** 中，数据库名和用户名偶尔不一致的问题。

### 已知问题

| 编号 | 已知问题      | 规避方法   |
|----|---------|---------------|
| 1  | 黑屏自定义的备份目录，可能在 OCP 上无法发起恢复。目前要求目录格式需要满足一定规范。 |修改备份目录与 OCP 备份目录格式一致。 |
| 2  |二次备份过程中删除调度策略可能会有配置残留，导致后续新建的备份策略调度失败。      | 参考如下步骤：<br>1. 等待二次备份结束。<br>2. 以 root@sys 用户登录集群所在机器，执行清空命令：`alter system set backup_backup_dest='';`。<br> 3. 白屏重试失败步骤。  |
| 3  | SQL 资源隔离对 SQL 的字符长度有限制，不能超过 128 字节。     | 不要使用过长的 SQL 作为资源隔离标识。   |
| 4  |合并管理图表特殊时间段样式可能会错乱。     | 静等系统自动修复即可。   |
| 5  | 资源隔离无法使用在 sys 租户上，否则会对整个集群的可用性产生影响。OCP 目前未做明确限制。     | 请勿对 sys 租户进行资源隔离行为。   |
| 6  | 通过 OCP 对特定资源设置访问权限可能会遇到问题。   | 请不要过多依赖 OCP 做特定资源的权限管理（具体到集群级别）。   |

### 版本使用限制

#### 硬件要求

OCP-Server 可以安装在物理机上，也支持安装运行在 Docker 容器中。OCP-Server 支持多节点高可用部署模式。

OCP-Server 节点最低硬件要求如下表所示。

| 硬件  | 要求                                 |
|-------|------------------------------------|
| CPU   | <li>X86_64，8 核</li><li>ARM aarch 64 架构，8 核</li> |
| 内存  | 可用内存 16 GB                         |
| 网卡  | 万兆网卡                               |

OCP-Agent 自身占用资源很少，对安装节点硬件资源没有特别要求。

#### 操作系统要求

安装 OCP 服务端（含 OCP-Agent）的操作系统要求如下表所示。

| 服务器类型       | 操作系统       | 支持版本      |
|-------------|------------|-----------|
| x86_64      | RHEL       | 7.2 及以上版本 |
| x86_64      | CentOS     | 7.2 及以上版本 |
| x86_64      | AliOS      | 7.2 及以上版本 |
| x86_64      | openSUSE   | 12SP3 及以上 |
| ARM aarch64 | AliOS      | 7.2 及以上版本 |
| ARM aarch64 | 中标麒麟       | 7.6       |
| ARM aarch64 | 华为 EulerOS | 2.0 SP8   |
| x86_64 | Debian       |   Debian GNU/Linux 11 (bullseye)    |
| x86_64 | Ubuntu |  Ubuntu 18.04.6 LTS  |

#### 客户端要求

一般用户会通过 Web 浏览器来访问 OCP 服务，故对客户端的要求如下所示。

| 浏览器     | 最小版本 |
|---------|------|
| Chrome  | 81   |
| Firefox | 64   |
| Safari  | 10   |
| Edge    | 13   |

如果您需要通过 iOS 操作系统的设备来访问 OCP，版本要求如下表所示。

| 操作系统 | 最小版本 |
|------|------|
| iOS  | 10   |

为了具备最佳的使用体验，推荐使用分辨率大于 1440 x 810 的显示器。
