# OCP V4.2.1

#RNDate#2023-11-21

## V4.2.1 BP1

### 版本信息

* **版本号：** V4.2.1 BP1

* **前置版本：** V4.2.1

* **版本发布日期：** 2023 年 12 月 08 日

### 缺陷修复

* 修复当数据量较大时 sys 租户资源会被过度消耗的性能问题。

* 修复单击任意时间组件时，前端页面卡死的问题。

* 修复部署单机集中式集群时，对 MySQL 客户端的依赖问题。

* 优化集群 **备份恢复** 页面中 **告警** 信息的获取速度。

* 优化 OCP 整体性能表现。减少 OCP 所需 CPU、内存资源使用消耗，大幅提高白屏页面的响应速度。

## V4.2.1

OCP V4.2.1 正式支持 OceanBase V4.2.1，同时支持对 OceanBase 全链路组件的可监控、可告警，包括支持用户自定义监控、完善支持租户和会话级全链路追踪以及增加对于OBLB&OBDNS 监控告警能力等。备份恢复方面实现支持腾讯云 COS，进一步完善对于国内主流云厂商存储介质的支持能力。另外，本版本在集群管理、租户管理、监控告警、任务管理等方面进行 17 项优化，着力提升产品的易用性，打造更加简单易用的数据库管理平台。

### 版本信息

* **版本号：** V4.2.1

* **前置版本：** V4.2.0

* **版本发布日期：** 2023 年 11 月 21 日

* **支持的升级路径：**

  * 目前仅支持从 OCP V3.2.4 及之后版本直接升级到当前版本。

  * 对于 OCP V2.3.x 及之后、V3.2.4 之前的版本，需先升级至 OCP V3.3.4 版本。

  * 对于 OCP V2.3.0 之前版本，需先升级至 OCP V2.3.x 版本，再升级到 OCP V3.3.4 版本。

### 支持的 OceanBase 数据库版本

OCP V4.2.0 版本支持下表所列版本的 OceanBase 数据库。

* OceanBase V1.4.x

* OceanBase V2.1.x

* OceanBase V2.2.x

* OceanBase V3.1.x

* OceanBase V3.2.x

* OceanBase V4.x

### 产品新特性

#### OceanBase V4.x 适配

* 支持租户和 Session 级别全链路诊断能力，帮助用户从客户端 > OBProxy > OceanBase 集群三个层面进行事务级别的耗时分析，从而快速定位问题根因，及时解决故障。本功能需要部署 OpenSearch 服务且对整个链路上的组件版本存在限制，详情请查看 [查询链路](../../1300.log-service/400.trace-query.md)。

* **备份恢复** 模块新增支持对接腾讯云 COS 存储类型（OceanBase 需为 V4.2.1 及以上版本）。

* 适配视图 `__all_virtual_dump_tenant_info`，实现对于租户队列使用情况的监控和告警。

* 适配租户配置项 tenant=all 语义，该配置项仅对普通租户生效，对 sys 及 Meta 租户不生效。

* 适配 RS job 视图变更，新增 `ALTER_TENANT_PRIMARY_ZONE`、`ALTER_TENANT_LOCALITY`、`ALTER_RESOURCE_TENANT_UNIT_NUM` 等任务类型。

* 支持展示 OceanBase 日志盘使用信息。

#### 功能提升

* **OBProxy 管理**

  * 支持对于 V3.2.8 及以上版本的 OBProxy 进行热重启的能力，解决停服运维或升级等操作影响在线业务。

  * 支持对于 OBProxy 集群进行启用、重启、停止以及 OBProxy 节点的批量启动、批量重启（包含热重启）以及批量停止等运维操作，完善 OBProxy 管理能力，提升用户操作效率。

* **监控告警**

  * 支持用户自定义监控能力，通过定义采集项以及监控项，并通过监控项与监控图表和告警相关联，实现用户定制化监控告警的能力，解决 OCP 内置告警无法满足客户业务诉求的场景（仅支持 sys 租户内相关指标告警）。

  * 支持 OBLB&OBDNS 的告警能力，共 16 个告警指标，如进程状态、进程连通性等，从而实现 OceanBase 整个架构体系的告警能力。

  * 支持活跃的 Memstore 占比的监控能力，查看路径为 **租户** > **性能监控** > **性能与 SQL** > **MEMStore 使用百分比**。

  * 支持租户转储次数监控，帮助用户预防 OceanBase V3.X 版本单租户转储次数超过转储阈值时触发集群级别的合并而造成的业务影响。

  * 支持当 OceanBase 回收站总空间占用超过 100GiB 时告警能力，降低因 OceanBase V3.X 回收站内分区数过多、清理不及时对客户业务造成影响。

  * 支持 OCP agent 与 OCP 版本不一致的告警，避免后续运维过程中的异常行为，并提升系统的稳定性。

* **巡检**

  * 支持服务器间联通性检测，包括 SQL 端口以及 RPC 端口，协助用户快速定位因网络、主机故障造成的业务中断。

  * 支持 OceanBase 宏块使用率检查，可帮助用户识别租户、表实际数据量以及磁盘占用量情况，进而通过合并操作降低磁盘空洞问题。

### 功能优化

* 对于集群、租户、OBProxy 等对象处于不可用以及主机处于离线状态时，支持异常原因分析，并提供错误信息、错误原因以及解决方案，帮助用户解决故障，保障业务稳定运行。

* 集群管理：

  * 支持添加 OBServer 和替换 OBServer 时指定启动参数，如 `memory_limit`、`system_memory` 等，解决当集群内机器硬件资源不一致时扩容失败、资源浪费等问题。

  * 支持新建仲裁服务时指定启动参数，如 `cpu_count`、`devname` 等。

  * 新增支持在重启集群、停止集群、重启 Zone、停止 Zone、重启 OBServer、停止 OBServer 进程时提供进行 Memstore 转储动作选项，主要解决在未执行转储的情况下 OBServer 恢复缓慢的问题。

  * 支持对于集群日志盘和数据盘的路径以及大小进行校验，如日志盘大小检测、数据盘和日志盘是否部署于同一物理磁盘等，并进行对应提示，避免后续数据库运行异常，提升系统稳定性。

  * 死锁检测增加提示语：OceanBase V3.X 版本的生产系统不建议开启本功能。

  * 提供低于 ARM8.1 的 Large System Extensions (LSE) 扩展指令支持的检测，避免 OceanBase 集群部署失败。

* 主机管理：

  * 支持主机 IP 关联至所属 OceanBase 集群或 OBProxy 集群，并支持快速跳转至对应集群。

  * 支持处于运维状态的主机（任务类型包括删除主机和 Reinstall OCP Agent）快速跳转至对应任务。

* 监控告警管理：

  * 支持区分活跃告警、历史告警以及状态栏增加活跃告警的显示提醒，提高用户对于当前活跃告警的关注度。

  * **告警** > **告警事件** 增加告警分类选项，帮助用户快速识别告警类型，提升产品易用性。

  * 告警信息内（如集群告警、租户告警、OBServer 告警）提供受影响的主机 IP 或者租户名称，可以帮助用户快速识别故障影响范围。

  * 集群名称变更为 `集群名称:集群 ID`，并增加集群主备标记。

* 备份恢复管理：

  集群名称变更为 `集群名称:集群 ID`，并增加集群主备标记。

* 日志服务管理：

  **链路查询** > **搜索内容** 新增 `sql_trace_id`、`trans_id`、`sess_id` 以及 `client_info` 等条件，帮助关联用户链路，从而有效提升查询效率。

* 任务管理：

  * 支持对于失败的任务展示异常信息并定位至首次报错日志位置，帮助用户高效定位故障原因。

  * 支持对于失败的任务进行批量重试的能力，如 Restart、ReInstall OCP Agent 等大量失败的场景，可以显著提升用户运维效率。

  * 支持处于运维中的集群、租户、OBProxy、主机等对象快速关联至任务，方便用户快速查看任务状态，以便后续运维操作。

### 产品行为变更

* 集群管理：**死锁分析** 变更为 **查看死锁历史信息**。

* 租户管理：**租户**（MySQL）> **用户管理** > **用户列表** 不支持展示不符合规则的用户名。

* 监控告警管理：**告警通道** > **通道类型**（自定义脚本）去除配置文件上传能力，避免升级场景下此类文件丢失的问题。

### 关键特性解读

#### 租户 && Session 级别全链路诊断

OceanBase 是一款分布式数据库，前后端调用链路极其复杂，当业务出现超时或者性能异常问题时，用户往往无法定位是 OceanBase 内部组件抑或是网络的问题，只能根据经验和 OBServer 日志进行分析，造成问题分析、解决耗时较长，从而影响了业务的稳定性。因此 OCP 提供全链路诊断机制，实现 Client > OBProxy > OBServer 整个链路的耗时监控，从而帮助用户快速定位问题根因。

如果您需要在 OCP 查看相关日志信息，请首先设置数据中台模块、链路查询采集以及 OpenSearch（ES） 相关参数，如仅需对部分租户或者 Session 开启，则请关闭其他租户的全链路诊断功能，并进入 **日志服务** > **链路查询** 页面，依据时间、租户、搜索内容（如 `sql_id`、`trans_id`、`sess_id` 等）以及链路耗时进行过滤。当前全链路诊断跟踪是以数据库的事务为维度，其会统计出链路耗时、驱动耗时、OBProxy 耗时、OB 耗时等数据，通过简单的耗时分析，您可以获悉当前的主要问题点，并进入对应的 Trace 查看具体的耗时（Span/Tag），从而快速发现真正的问题点。

<main id="notice" type='notice'>
<h4>注意</h4>
<p><li>当前全链路监控是默认开启的，在默认参数下对于租户性能影响约为 2%，请在性能测试或者 POC 场景请关闭本功能。</li><li>此功能版本限制如下：<ul><li>OB-Server >= V4.0.0.0</li><li>OBProxy >= V4.0.0</li><li>OB-JDBC >= V2.4.0</li><li>OCP >= V4.0.3</li><li>OBClient >= V2.2.0</li></ul></li></p>
</main>

#### 自定义监控

自定义监控用于在 OCP 内置监控无法满足用户需求时，用户可以贴合自身业务场景定制化监控图表以及告警，方便用户及时感知系统内在变化，从而及时快速的做出决策。
整个功能模块分为采集项，指标项和图表三大页签，其中：

1. 采集项代表从不同数据源采集的原始监控数据，当前系统已内置 50+ 个采集项。

2. 指标项代表基于采集项生成的计算指标，如最大值、最小值或者平均值等数十种算法，您可依据对于监控数据的使用进行选择或者自定义表达式方式进行创建，当前系统已内置 200+ 个监控项。

3. 图表可以由一条或多条指标项组成，并支持选择图表放置位置和进行图表预览。同时用户可以基于指标项通过自定义告警功能实现对于对应指标监控的能力。

<main id="notice" type='notice'>
<h4>注意</h4>
<p>当前仅能通过 Open API 的方式创建采集项。</p>
</main>

### 修复的问题

OCP V4.2.1 版本主要修复了如下问题：

* 修复 OCP 非 admin 用户无法访问告警详情的问题。
* 修复回滚创建 OBProxy 任务时，回滚不彻底而导致重新部署 OBProxy 失败的问题。
* 修复无法在 OCP 端修改租户变量 `max_allowed_packet` 的问题。
* 修复租户会话数统计不正确的问题。
* 优化 OCP 从 V3.3.x 升级至 V4.2.x 版本，当有大量监控数据时升级速度变慢的问题。
* 优化采集的数据量，提高了采集性能和稳定性。
* 优化运维 SQL 的超时逻辑，目前支持设置且表现更稳定。
* 优化 monagent 日志，避免产生大量无用 debug 日志。
* 优化了 MetaDB 不可用时的告警表现。

### 已知问题

| 编号 | 已知问题      | 规避方法   |
|----|---------|---------------|
| 1  | OBProxy V4.1.x 版本，在 OCP 上创建 OBProxy 集群后，因 OBProxy 自身问题会导致无法连接。 | 建议使用 OBProxy V4.2.1 及以上版本。 |
| 2  | 租户资源趋势监控数据在升级后历史数据会因格式不兼容而丢失。| 确保租户资源趋势历史数据可以丢弃的前提下，再进行升级。 |

### 版本使用限制

#### 硬件要求

OCP-Server 可以安装在物理机上，也支持安装运行在 Docker 容器中。OCP-Server 支持多节点高可用部署模式。

OCP-Server 节点最低硬件要求如下表所示。

| 硬件  | 要求                                 |
|-------|------------------------------------|
| CPU   | <li>X86_64，8 核</li><li>ARM aarch 64 架构，8 核</li> |
| 内存  | 可用内存 16 GB                         |
| 网卡  | 万兆网卡                               |

OCP-Agent 自身占用资源很少，对安装节点硬件资源没有特别要求。

#### 操作系统要求

安装 OCP 服务端（含 OCP-Agent）的操作系统要求如下表所示。

| 服务器类型       | 操作系统       | 支持版本      |
|-------------|------------|-----------|
| x86_64      | RHEL       | 7.2 及以上版本 |
| x86_64      | CentOS     | 7.2 及以上版本 |
| x86_64      | AliOS      | 7.2 及以上版本 |
| x86_64      | openSUSE   | 12SP3 及以上 |
| ARM aarch64 | AliOS      | 7.2 及以上版本 |
| ARM aarch64 | 中标麒麟       | 7.6       |
| ARM aarch64 | 华为 EulerOS | 2.0 SP8   |
| x86_64 | Debian       |   Debian GNU/Linux 11 (bullseye)    |
| x86_64 | Ubuntu |  Ubuntu 18.04.6 LTS  |

#### 客户端要求

一般用户会通过 Web 浏览器来访问 OCP 服务，故对客户端的要求如下所示。

| 浏览器     | 最小版本 |
|---------|------|
| Chrome  | 88   |
| Firefox | 78   |
| Safari  | 14   |
| Edge    | 88   |

如果您需要通过 iOS 操作系统的设备来访问 OCP，版本要求如下表所示。

| 操作系统 | 最小版本 |
|------|------|
| iOS  | 10   |

为了具备最佳的使用体验，推荐使用分辨率大于 1440 x 810 的显示器。
