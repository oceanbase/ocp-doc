后台任务列表
===========================

本节主要列举了 OCP 内部的常驻的后台任务，是由 OCP Server 定期触发并执行的一类任务总称，主要用于维护 OCP 以及被管理目标的状态检查、数据清理。

后台任务的调度和运行历史，可以参考 OCP 元数据库（MetaDB）中的 `dag_instance` 和 `task_instance` 表的详情（通过 `dag_instance.id = task_instance.dag_id` 进行 `join` 查询）。 dag_instance 记录的是整个后台任务的执行详情，而 task_instance 记录的是当前后台任务下每个子任务的执行详情。

后台任务执行的日志，可以到 `logging.file` 配置参数指定的 OCP 日志文件中，根据特定关键字搜索。OCP 日志文件默认为 `${user.home}/logs/ocp/ocp.log`。

以下是常驻后台任务列表，包含任务名、任务描述、备注、状态排查等信息，可用于 OCP 系统管理员的参考和问题排查。

**后台任务列表**


|                   **任务名称**                   |                                                                                         **任务描述**                                                                                         |      **调度表达式**      |                                                                                          **问题排查 - 数据库**                                                                                           |                                                                                                                                                                                                                                                                                                         **问题排查 - OCP日志**                                                                                                                                                                                                                                                                                                         |
|----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Archive alarm history data                   | 归档过期的告警屏蔽配置与通知信息。                                                                                                                                                                        | 0 0 3 \* \* \*      | ocp2_alarm_filter （告警屏蔽配置） ocp2_alarm_notification （告警通知） ocp2_alarm_filter_history （屏蔽配置历史） ocp2_alarm_notification_history （通知历史）               | "Archive expired alarm history data: result=archive \[filter\|notification\] success, affectRows=xxx"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Sync all cluster info                        | 定期同步 OCP 管理的 OceanBase 集群信息，并更新到 ob_cluster 表。 仅当 ob_cluster 表的 operateStatus 为NORMAL，且 clusterStatus 为 RUNNING 时进行更新。                                                   | 0 \* \* \* \* \*    | ob_cluster （OCP 管理的集群信息）                                                                                                                                                                          | "cluster sync success, cluster= \[id=xx,name=xx,..\]" -- 成功  "cluster sync failed, cluster=xxx, exceptionType=xxx, message=xxx" -- 异常  -- 同步过程日志 " syncForCluster start, clusterId=xx init clusterSyncContext, context=xx create clusterOperator, clusterId=xx get current from ob cluster, clusterId=xx updateZones done, clusterId=xx syncForCluster done, clusterId=xx "                                                      |
| Refresh config properties                    | 刷新 OCP 的配置信息。                                                                                                                                                                            | 0 \*/10 \* \* \* \* | config_properties （OCP 系统参数配置）                                                                                                                                                                    | "Refresh config properties on \[host:port\] at \[date \& time\] "                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Maintain partition for monitordb             | 处理 monitor 租户的分区，每天会按照特定的策略为分区表新建新的分区，删除过期的分区。                                                                                                                                           | 0 0 1 \* \* \*      | Monitor DB 数据库： ob_cluster_system_event (采集的 OceanBase Root Service 事件) ob_metric_data_1 （每秒采集的监控数据） ob_metric_data_60 (每 60 秒采集的监控数据)            | -- 分区维护成功 "partition maintain start partition maintain success" -- 分区维护失败 "partition maintain failed \[exception msg\]"                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| Sync system event                            | 同步系统事件，从 OB 集群中，定期同步 Root Service 事件到 monitordb 的 ob_cluster_system_event。                                                                                                               | 0 \*/10 \* \* \* \* | Monitor DB 数据库： ob_cluster_system_event (采集的 OceanBase Root Service 事件)  OceanBase 内部表： oceanbase.__all_rootservice_event_history | -- 同步成功 "Batch saved \[记录数\] events to database for cluster \[cluster id\] Sync-ed  \[记录数\]  system events for cluster \[cluster id\], startTime \[开始时间\], endTime \[结束时间\], limit \[limit\], offset \[offset\] Finished sync system events: cluster \[cluster id\],  startTime \[起始时间\], endTime \[结束时间\] "  -- 同步失败 "An exception occurred when saving events \[exception log\]"                                                                                                                                               |
| Check all cluster status                     | 定期检查 ob_cluster 表中OceanBase 集群的"存活状态"（通过测试建立数据库连接来检查）。如果不成功，则打印错误日志，并发送告警。                                                                                                               | 0 \* \* \* \* \*    | ob_cluster （OCP 管理的集群信息）                                                                                                                                                                          | -- cluster 能连接 "check cluster status okay, clusterId=\[cluster id\], obVersion=\[ob version\]"  -- cluster 不能连接 "check cluster status unavailable, clusterId=\[cluster id\], failedReason=\[exception msg\]"  -- 告警类别与关键字 "ob_cluster_status_check_failed" + "cluster connect check"                                                                                                                                                                                                                             |
| Check host status                            | 检查 host 上 pos_proxy 能否执行远程命令（whoami），如果执行失败会发送报警，并修改主机状态 (OFFLINE)，如果正常会将状态修改为正常状态 (AVAILABLE, ONLINE)。  检查 host 上 node_exporter 数量，如果数量不对，则打印异常信息并发送告警。 | 0 \* \* \* \* \*    | compute_host.status compute_host_agent.last_available_time ocp_exporter_address                                                                                   | "Host agent check result: current OS user is root" -- agent 检查成功 "Check exporter status: host \[id\] desired exporter count: \[number\], actual exporter count: \[number\]" -- exporter 检查成功  "Host agent check failed: host \[host id\] reason  \[exception msg\]" -- agent 检查失败 "Alarm: host_unavailable for host ip \[ip address\]" -- exporter 检查失败 "Alarm: no_enough_exporter for host \[id\]" -- exporter 检查失败  "host_unavailable" -- agent 失败告警类别 "no_enough_exporter" -- exporter 失败告警类别 |
| Submit scheduled dag                         | 实现了类似于主机上 crontab 的功能，用于提交用户自定义的定时任务，会检查用户定义的调度表达式和当前实际比较，满足条件，则提交用户定义的任务；否则更新 dag_schedule 表对应记录状态为 ABNORMAL。                                                                           | 0 \* \* \* \* \*    | dag_schedule （任务调度详情） dag_instance (后台任务运行详情)                                                                                                                                     | -- 当前无用户自定义任务 "no cron job available in dag_schedule"  -- 提交自定义任务出错 "failed to get template for class \[java class name\], got exception: \[exception msg\]"                                                                                                                                                                                                                                                                                                                                                                                                     |
| Clean ocp task log files                     | 清理 OCP 主机上 task 日志。                                                                                                                                                                      | 0 0 1 \* \* \*      | 无                                                                                                                                                                                                 | OCP 清理日志的Python 脚本： 'user.home' -\> '/ocp-server/python-task/src/task/ob_task_clean_log.py'  待清理的 Task 日志目录： 'user.home' -\> '/logs/task/'  清理日志的 Python 进程日志文件: 'user.home' -\> '/logs/task/task.2.xxx.log'  OCP 清理任务异常日志： "failed to clean task log files: \[exception msg\]"                                                                                                                                                                                  |
| Collect all cluster compaction info          | 收集所有集群的合并信息。                                                                                                                                                                             | 0 \* \* \* \* \*    | ob_cluster_compaction (OB 集群合并记录) ob_zone_compaction （OB Zone合并记录） ob_server_compaction （OB Server 合并记录） ob_tenant_compaction_stats （OB 租户合并记录）   | -- 收集成功 "Update cluster \[cluster id\] compaction status: from \[xx\] to \[xx\]" "Compaction post collect done, clusterId= \[cluster id\], version=\[version\]"  -- 收集失败 "Skip collect for not RUNNING cluster, clusterId=\[cluster id\], status=\[xx\]" "Skip collect for version 1, the first compaction will be version 2" "Validate compaction version failed: \[reason\]"                                                                                                                                   |
| Sync tenant information                      | 同步租户信息。                                                                                                                                                                                  | 30 0/2 \* \* \* ?   | ob_tenant (OB 租户信息表)                                                                                                                                                                              | -- 同步成功 "\[SyncAllTenantInfoTask\] begin to sync tenant." "\[SyncAllTenantInfoTask\] sync tenants of specified cluster, clusterId=\[cluster id\]" "\[SyncAllTenantInfoTask\] sync tenant finished."  -- 同步失败 "Zero tenants found for cluster \[cluster id\]"                                                                                                                                                                                                                                                                     |
| Detect alarms on schedule                    | 备份恢复相关的告警检测器。                                                                                                                                                                            | 0 \*/1 \* \* \* \*  | dag_schedule （任务调度详情） dag_instance (后台任务运行详情)                                                                                                                                     | --执行成功 generate tasks, templateName=Detect alarms, nodeCount=1, taskCount=1 set state running for task: \[task id\] set state successful for task: \[task id\] --执行失败 打印异常调用栈 关键词：BackupAlarmService                                                                                                                                                                                                                                                                                                                             |
| Clean expired data and log files on schedule | 备份恢复相关的定时清理器，清理过期数据和清理过期日志。                                                                                                                                                              | 0 0 0 \* \* \*      | dag_schedule （任务调度详情） dag_instance (后台任务运行详情)                                                                                                                                     | --执行成功 generate tasks, templateName=Clean expired data and log files, nodeCount=1, taskCount=1 set state running for task: \[task id\] set state successful for task: \[task id\] --执行失败 打印异常调用栈 关键词：BackupCleanService                                                                                                                                                                                                                                                                                                          |
| Check system obproxy                         | 检查 OCP 所使用的系统 obproxy 的健康状态。                                                                                                                                                             | 0 \* \* \* \* \*    | OCP 系统参数： ocp.system.obproxy.address ocp.system.obproxy.port                                                                                                      | --系统 obproxy 状态正常 打印日志 `system obproxy is running` --系统 obproxy 状态不正常 打印日志 `system obproxy is down` 同时，会推送一条告警 --检查方法执行失败 打印异常调用栈， `check connection of system obproxy failed. exception: xxx`                                                                                                                                                                                                                                                                                                                                   |
| Collect cluster daily metric                 | 采集 daily 统计的集群监控指标。                                                                                                                                                                      | 0 0 5 \* \* \*      | 无                                                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Check obproxy                                | 检查业务 obproxy 是否正常。                                                                                                                                                                       | 0 \* \* \* \* \*    | obproxy_server ( obproxy server 元数据表)                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Sync root service list                       | 同步 ob 的 rs_list 地址。                                                                                                                                                                      | 0 \*/2 \* \* \* ?   | ob_cluster （OCP 管理的集群信息）                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Sync obpaas information                      | 同步 obpass 信息。                                                                                                                                                                            | 40 0/2 \* \* \* ?   | 无                                                                                                                                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| SQL stats partitioning                       | SQL 性能表的分区守护。                                                                                                                                                                            | 0 0 \*/1 \* \* \*   | dag_schedule （任务调度详情） dag_instance (后台任务运行详情) OCP 系统参数：ocp.perf.sql.partition-worker-disabled ，可关闭任务逻辑。                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Refresh agent config                         | OCP 将 Agent 配置信息定期推送到每台主机上。                                                                                                                                                              | 0 \*/10 \* \* \* \* | 无                                                                                                                                                                                                 | OCP 日志：`Refreshing OCP agent configuration` ，主机上配置信息存储的位置：`/home/admin/ocp_agent/conf/config.conf` 配置信息文件的内容为： \[OCP_API\] api_url =[http://xxx.xx.xxx.xxx:8080/services](http://100.88.121.149:8080/services) \[HOST\] ip = [xxx.xx.xxx.xxx](http://100.88.121.149:8080/services) \[CLUSTER\] name = xxx \[OBPROXY\] id = x name = __obproxy__ port = xxxx exporter_port = XXXX（与 obproxy__ port 为不同端口）                                                                                                                                                                                         |



**调度表达式**

调度使用的如下格式的 Cron 表达式，包含了 6 位字段，如下：

```code
second, minute, hour, day of month, month, day(s) of week
```



**Cron 表达式字段和取值**


|   **字段名**    |    **取值范围**    | **支持的特殊字符** |
|--------------|----------------|-------------|
| second       | 0-59           | ,-\*/       |
| minute       | 0-59           | ,-\*/       |
| hour         | 0-23           | ,-\*/       |
| day of month | 1-31           | ,-\*/?      |
| month        | 1-12 或 JAN-DEC | ,-\*/       |
| day of week  | 1-7 或 MON-SUN  | ,-\*/?      |



**表达式示例：**


|          **表达式**           |                              **说明**                               |
|----------------------------|-------------------------------------------------------------------|
| **0 0 \* \* \* \***        | "0 秒 0 分" - 每小时运行一次，在 0 秒 0 分启动。                                  |
| **\*/10 \* \* \* \* \***   | 每 10 秒钟运行一次。                                                      |
| **0 0 8-10 \* \* \***      | 每天的 8, 9 和 10 点钟运行一次，在 0 秒 0 分启动。                                 |
| **0 0/30 8-10 \* \* \***   | 每天 8:00, 8:30, 9:00, 9:30,10:00 和 10:30 运行。                       |
| **0 0 9-17 \* \* MON-FRI** | 从周一到周五的上午 9 点到下午  5 点运行。                                          |
| **0 0 9-17 \* \* 1-5**     | 从周一到周五的上午 9 点到下午 5 点运行，使用数字表达周几，1 代表周一，7 代表周日。与 crontab 的表达式稍有不同。 |
| **0 0 0 25 12 ?**          | 每年  12/25 日凌晨 0 点 0 分 0 秒。                                        |
